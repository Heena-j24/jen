pipeline {
    agent { label 'controller' }
    environment {
        IMAGE_NAME = "mindtreerepo"
        IMAGE_TAG  = "${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo "Checking out source code"
                git 'https://github.com/Heena-j24/tomcatdevops'
                sh 'cp -r * /var/lib/jenkins/efs'
            }
        }

        stage('Build Application (Java + Maven)') {
            agent { label 'build' }

            steps {

                sh '''
                    cd /home/jenkins/workspace
                    mvn clean package
                    cd target
                    cp ROOT.war /home/jenkins/workspace && cd ..
                    ls -al
                '''
            }
        }

        stage('Build & Push Docker Image') {
            agent { label 'docker' }
            steps {
                sh '''
                    cd /home/jenkins/workspace
                    ls -al
                    docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 957172857669.dkr.ecr.ap-south-1.amazonaws.com
                    docker tag mindtree:latest 957172857669.dkr.ecr.ap-south-1.amazonaws.com/mindtree:latest
                    docker push 957172857669.dkr.ecr.ap-south-1.amazonaws.com/mindtree:latest
                '''
            }
        }

        stage('Deploy to Kubernetes') {
            agent { label 'docker' }

            steps {
                sh '''
                    cd /home/jenkins/workspace
                    sudo kubectl apply -f deployment.yml
                    sudo kubectl apply -f svc.yml
                '''
            }
        }
    }

}

